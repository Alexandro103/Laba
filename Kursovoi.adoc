= Отчет по курсовой работе
Шумаков А.С. <КЭ-413>
:imagesdir: image
:toc:
:toc-title: Оглавление
:figure-caption: Рисунок
:table-caption: Таблица
:sectnums: |,all|
:stem: latexmath
:numbered:

== Нефункциональные требования

[start = 1 ]

	. Архитектура:

	- Программное обеспечение должно быть разработано с использованием FreeRTOS и C++ обертки

	- Архитектура программы должна быть представлена в виде UML-диаграмм (классов, последовательностей, компонентов) в PlantUML

	. Стиль и стандарты:

	- Комментарии и структура кода должны быть понятны и поддерживаемы


	. Датчики и интерфейсы:

	- Измерение давления, влажности и температуры должно выполняться с помощью датчика BME280

	- Общение с датчиком BME280 должно происходить по SPIx, где x ≠ 1, 2, 3


	- Передача данных по Bluetooth через модуль HC-06 по 
    интерфейсу USART2


	. Измерения:

	- Период измерения параметров: 100 мс


	- Программа должна рассчитывать точку росы на основе текущих значений температуры и влажности


	. Формат вывода данных (через Bluetooth):

- "Давление: " XXX.XX [единицы измерения]

- "Влажность: " XXX.XX [единицы измерения]

- "Температура: " XXX.XX [единицы измерения]

- "Точка росы: " XXX.XX C

	- Период передачи данных по Bluetooth: 1 секунда

	. Ограничения

	.. Аппаратные ограничения:
 
	- Запрещено добавлять или убирать строки в выводе.

	- Расчет точки росы должен выполняться только на основе текущих данных (без усреднения или фильтрации).


.. Ограничения по демонстрации:

	- Запрещено использовать эмуляторы (только работа на реальной плате).

== Функциональные требования


[start = 1 ]

	. Надежность:
  
	- Корректная работа в автономном режиме (солнечное питание).

	. Сопровождаемость:

	- Код должен быть читаемым, документированным и модульным.


== Анализ требований 

.Взаимодействие элементов системы
image::schem_of_system.png[]

На изображении представлена схема подключения компонентов метеостанции к микроконтроллеру STM32:

=== Отладочная плата 

Отладочная плата XNUCLEO-F411RE на базе микроконтроллера STM32F411RE представляет собой ключевой компонент разрабатываемой системы. Данная плата оснащена 32-битным процессорным ядром Cortex-M4 с тактовой частотой 100 МГц, что обеспечивает достаточную производительность для реализации многозадачного программного обеспечения на операционной системе реального времени FreeRTOS. 

.Отладочная плата XNUCLEO-F411RE
image::plata.jpg[]

Объем встроенной памяти составляет 512 КБ Flash и 128 КБ RAM, что позволяет разместить комплексное приложение с поддержкой C++ и необходимыми библиотеками для работы с периферийными устройствами.

Для организации связи с датчиком BME280 используется интерфейс SPI. Согласно техническому заданию, должен быть задействован один из альтернативных SPI-портов (x ≠ 1,2,3). 

Плата предоставляет доступ к SPI4 (пины PE2, PE5, PE6, PE13) и SPI5, что соответствует требованиям проекта. Настройка интерфейса осуществляется в режиме Full-Duplex Master с частотой обмена данными, соответствующей характеристикам датчика.

=== Настройка SPI2 STM32F411RE

.Регистры RCC
[%autowidth]
|===
| Регистр | Назначение | Ключевые биты | Тип данных | Источник(https://goo.su/hUoKshN)

| *RCC_CR* 
| Управление источниками тактирования 
| `HSION`(0), `HSIRDY`(1), 
`HSEON`(16), `HSERDY`(17), 
`PLLON`(24), `PLLRDY`(25)
| `uint32_t`
| RM0090 (стр. 163)

| *RCC_PLLCFGR* 
| Конфигурация PLL 
| `PLLM`(0-5), `PLLN`(6-14), 
`PLLP`(16-17), `PLLSRC`(22)
| `uint32_t`
| RM0090 (стр. 165)

| *RCC_CFGR* 
| Распределение тактовой частоты 
| `SW`(0-1), `HPRE`(4-7), 
`PPRE1`(10-12), `PPRE2`(13-15)
| `uint32_t`
| RM0090 (стр. 167)

| *RCC_AHB1ENR* 
| Тактирование AHB1 периферии 
| `GPIOAEN`(0), `GPIOBEN`(1), 
`DMA1EN`(21), `DMA2EN`(22)
| `uint32_t`
| RM0090 (стр. 182)

| *RCC_APB1ENR* 
| Тактирование APB1 периферии 
| `USART2EN`(17), `SPI2EN`(14), 
`I2C1EN`(21), `PWREN`(28)
| `uint32_t`
| RM0090 (стр. 185)

| *RCC_APB2ENR* 
| Тактирование APB2 периферии 
| `USART1EN`(4), `SPI1EN`(12), 
`ADC1EN`(8), `TIM1EN`(0)
| `uint32_t`
| RM0090 (стр. 189)


|===


Используется аппаратный SPI. Он на частотах до 25 MHz (для BME280 достаточно 10 MHz).У  аппаратного SPI нет задержек из-за прерываний.



Датчик BME280 поддерживает интерфейсы I²C и SPI, что делает его гибким для интеграции в различные системы. В данном проекте используется SPI из-за его высокой скорости и надёжности в условиях помех.

Особенности работы с BME280 по SPI

- Режим SPI:

CPOL = 0, CPHA = 0 (Mode 0) — стандартный режим для BME280.

- Скорость обмена:

Максимальная частота SCK для BME280 — 10 МГц

- Чтение/запись:

Первый бит адреса регистра указывает на операцию:

0x80 | reg — запись.

reg & 0x7F — чтение.




.Конфигурация линий SPI2
[horizontal]
[cols="a, a"]
|===
|Пин	|Наименование линии

|PB12	
|NSS

|PB13	
|SCK

|PB14	
|MISO

|PB15	
|MOSI
|===

.Регистры необходимые для настройки SPI2
[%autowidth]

|===
|Поля регистра SPI_CR1	|Описание | Тип данных |Состояния

|SPE	
|включение SPI	
| `bool`
|1 - Периферийное устройство включено.

|MSTR	
|Выбор мастера
| `bool`	
|1 - Master конфигурация.

|DFF	
|формат кадра данных
| `bool`	
|0 -для передачи/приема выбран 8-битный формат кадра данных.

|BR	
|Контроль скорости передачи данных
| `uint3_t`	
|000 - fPCLK/2

|CPOL,CPHA	
|программнно выбираются четыре варианта отношений таймингов интерфейса SPI
| `bool`	
|0 (CPOL,CPHA устанавливаются в 0, так как интерфейс SPI датчик BME280 совместим с режимом CPOL = CPHA = 0.)(https://roboparts.ru/upload/iblock/3ba/3ba8b9a547c432e79276186dd829340c.pdf?ysclid=m9n0hdi53p805898292 стр. 32)
|===

[%autowidth]

|===
|Поля регистра SPI_DR | Тип данных	|Описание

|DR	
| `uint16_t
|Регистр данных разделен на 2 буфера: один для записи (Transmit Buffer), другой для записи. чтение (Receive buffer)
|===

[%autowidth]

|===

|Поля регистра SPI_SR	|Описание | Тип данных	|Состояния

|BSY	
|флаг занятости.
| `bool`	
|0 - SPI не занят. 1 - SPI занят связью или буфер 

|Tx не пуст.
|TXE	буфер передачи пуст.	
| `bool`
|0 - буфер передачи не пуст. 1 - буфер передачи пуст
|===



Для настройки скорости SPI требуется придерживаться временной диаграммы интерфейса SPI датчика BME280


.Временная диаграмма SPI
image::time_diagram.png[]

.Тайминги SPI
[%autowidth]
|===
| Параметр | Краткое обозначение | Min | Max | Единица измерения

|Входная тактовая частота SPI|F_spi|0|10| МГц

|Низкий импульс SCK|T_low_sck |20 || нс

|Высокий импульс SCK|T_high_sck|20||нс

|Время установки SDI|T_setup_sdi|20||нс

|Время удержания SDI|T_hold_sdi|20||нс

|Задержка выхода SDO|T_delay_sdo, VDDIO = 1.6 V min||30|нс

|Задержка выхода SDO|T_delay_sdo, VDDIO = 1.2 V min||40|нс

|Время установки CSB|T_setup_csb|20||нс

|Время удержания CSB|T_hold_csb |20||нс
|===

Рассчитаем полный временной тайминг:

[latexmath]
++++
T_{All} = T_{low\_sck} + T_{high\_sck} + T_{setup\_sdi} + T_{hold\_sdi} + T_{delay\_sdo} + T_{setup\_csb} + T_{hold\_csb} = 150\,\text{нс}
++++

Переведем из временного интервала в частоту, используя условия 1 Гц = 1 цикл/с, следовательно

[latexmath]
++++
Frequency = \frac{1}{T_{All}}
++++

[latexmath]
++++
Frequence=6,67 МГц
++++

Датчик BME280 физически не может обрабатывать данные быстрее, чем 6.67 МГц. Если превысить эту частоту — данные будут теряться. Для стабильной работы возьмем частоту с запасом 4 МГц. Чтобы получить 4 МГц установим тактовую частоту генератора STM32 на 16 МГц и в регистре SPI установить значение 1 в бит BR (делитель частоты = 4), что даст частоту в 4,0 МГц на интерфейсе SPI2.


 
.Распиновка платы XNUCLEO-F411RE
image::pin_of_lab2.jpg[]

Передача метеоданных по беспроводному каналу реализована через модуль HC-06, подключенный к интерфейсу USART2. 

Используются стандартные пины PA2 (TX) и PA3 (RX), которые выводятся на контакты платы расширения Accessories Shield или I/O Expansion Shield. Скорость обмена установлена на 9600 бод, что является штатным режимом работы данного Bluetooth-модуля.

Настройка USART:
[start]
. Выбор пинов USART

- TX → PA2 (передача данных)

- RX → PA3 (приём данных)

. Настройка тактирования
Включите тактирование USART и GPIO:

. Конфигурация GPIO
Настройте пины PA2 (TX) и PA3 (RX) в альтернативный режим (AF7 для USART2):


. Настройка регистров USART

- Рассчитать значение BRR для нужной скорости
. Включение USART

Последовательность передачи по USART:
[start]

. Старт-бит. Посылка начинается со стартового бита, который всегда имеет значение лог. 0.

. Биты данных. Количество битов данных может составлять 5–9 в зависимости от настроек USART. Обычно передаётся 8 бит данных или 9 бит (8 бит собственно данных и один бит чётности). 

. Стоп-биты. Посылка завершается стоп-битами, их значение — всегда лог. 1, количество обычно составляет 1, 1,5 или 2. 

. Передача следующей посылки. Сразу же после стоп-битов может начинаться передача следующей посылки или может быть пауза произвольной длительности.

.Подключение линий данных USART2
[%autowidth]
|===
| Наименование линий на STM| Пин на плате STM| Наименование линий на BlueTooth Bee HC-06  

| RX_STM | PD5 | TX_HC06 

| TX_STM | PD6 | RX_HC06
|===

Плата поддерживает подачу напряжения через разъем Vin (7-12 В) или E5V (5 В), что позволяет использовать солнечную батарею в качестве первичного источника энергии. Для стабилизации напряжения и защиты схемы рекомендуется включение в цепь дополнительного регулятора напряжения. 

=== Модуль HC-06

Модуль HC-06 – Bluetooth-передатчик для последовательной связи (UART) с ПК или смартфоном. Подключён к USART2 платы XNUCLEO-F411RE через плату расширения. Передаёт данные каждую секунду в формате:

"Давление: XXX.XX гПа

Влажность: XXX.XX %

Температура: XXX.XX C

Точка росы: XXX.XX C"
 
.Модуль HC-06
image::module_hc06.png[]

Работает на скорости 9600 бод, питается от 3.3–5 В, потребляет ~30 мА. Прост в настройке (базовые AT-команды), обеспечивает стабильную связь на расстоянии до 10 м.

=== Анализ и реализация периодичности измерений (100 мс)

Для обеспечения периодичности измерений в 100 мс будут использован таймер (TIM)

Таймер TIM2 будет настроен на генерацию прерывания каждые 100 мс.

  Настройка таймера:

- Тактовая частота APB1: 42 МГц.
- Предделитель (PSC): 41999 (для уменьшения частоты до 1 кГц).
- Счетчик (ARR): 99 (1000 Гц / 10 = 100 мс).

=== Анализ передачи данных через Bluetooth (HC-06)

Для передачи данных через Bluetooth модуль HC-06 используется USART2. Ниже приведена детальная настройка и алгоритм работы.

Настройка USART2:

- Скорость передачи: 9600 бод.
- Формат данных: 8 бит данных, 1 стоп-бит, без контроля четности.
- Пины: PA2 (TX), PA3 (RX).

Данные форматируются в строку и отправляются каждую секунду.

=== Датчик BME280

Датчик BME280 – цифровой сенсор для измерения температуры, влажности и атмосферного давления. В проекте подключён к микроконтроллеру через интерфейс SPI (используется порт SPIx, где x≠1,2,3). 

Обеспечивает высокую точность измерений: ±1°C для температуры, ±3% для влажности и ±1 гПа для давления.
 
.BME280
image::BME280.png[]


Датчик работает с частотой опроса 100 мс. Полученные данные используются для расчёта точки росы по формуле Магнуса. Питание осуществляется от 3.3 В, потребление в активном режиме – до 3.6 мкА при измерении всех параметров.

.Параметры датчика
[%autowidth]
|===
|Измеряемые физические величины | Система единиц |Регистры, где находятся необработанные выходные данные| объем данных, бит

| Давление | паскаль | 0xF7 - 0xF9  | 20 
| Температура | градусы цельсия | 0xFA - 0xFC  | 20 
| Влажность | % | 0xFD - 0xFE |  16 
|===

.Регистры настройки сбора данных
[%autowidth]
|===
|Регистр|Описание
|0xF4|Данные регистр используется для управления передискретизацией данных температуры и давления
|0xF2|Данные регистр используется для управления передискретизацией данных влажности
|===

Для регистра 0xF2 (ctrl_hum):

- Управляет только влажностью (биты 0-2)

- Перед изменением требует сначала записи в 0xF4

Для регистра 0xF4 (ctrl_meas):

- Комбинированный регистр (биты 7-5 - temp, 4-2 - press, 1-0 - режим)




Источник :
https://roboparts.ru/upload/iblock/3ba/3ba8b9a547c432e79276186dd829340c.pdf?ysclid=m9n0hdi53p805898292 (страницы : 25, 26 )



.Регистры необходимые для настройки датчика
[%autowidth]
|===
|Регистр | Описание | Тип данных| Страница в документации 

| 0x76| Адрес BME280 | uint8_t (константа)
 | 31

| 0xD0| ID регистр BME280 | uint8_t (read-only)
 | 25

| 0x60| Информация, читаемая от BME280 в ID регистре | uint8_t  |  24

| 0xE0| Регистр для перезагрузки BME280 | uint8_t (write-only)| 25

| 0xB6| Значение, записываемое в регистр для перезагрузки BME280 | uint8_t | 25

| 0xF3| Регистр статуса BME280 | uint8_t (read-only)
 | 25

| 0xF5| Регистр конфигурации BME280, задаём время ожидания, значение постоянной времени
фильтра BME280 | uint8_t (read/write)
 | 28
|===
Источник на регистры необходимые для настройки датчика:
https://roboparts.ru/upload/iblock/3ba/3ba8b9a547c432e79276186dd829340c.pdf?ysclid=m9n0hdi53p805898292

.Регистры калибровки
[%autowidth]
|===

|Адрес регистра|Обозначение регистра|Тип данных

|0x88 - 0x89|dig_T1|unsigned short

|0x8A - 0x8B|dig_T2|signed short

|0x8C - 0x8D|dig_T3|signed short
|===

Источник регистров калибровки :
https://roboparts.ru/upload/iblock/3ba/3ba8b9a547c432e79276186dd829340c.pdf?ysclid=m9n0hdi53p805898292 (страница 22)

	- dig_T - Обозначение регистра откуда читаем калибровочное значение температуры

	- Все данные передаются младшим байтом в перед, поэтому будет необходима функция перестановки байтов

Преобразование температуры в градусах Цельсия (°C):

[latexmath]

++++
X = \frac{adc_T}{16} - dig_{T1}
++++

	- гдe adc_T — значение температуры полученное из регистра

[latexmath]
++++
T_f = \frac{X \cdot dig_{T1} + \frac{X^2 \cdot dig_{T3}}{65536}}{1024}
++++

	- гдe Tf — конечное значение температуры

Преобразование давления в паскалях :

[latexmath]

++++
D_F = \frac{adc_D}{16} \times 0.18
++++

	- гдe adc_D — значение давления полученное из регистра

	- D_F — конечное значение давления

Преобразование Влажности в % относительной влажности (RH%):

[latexmath]
++++
H_F = adc_H \times 0.008
++++

	- гдe adc_H — значение влажности полученное из регистра

	- Hf — конечное значение влажности

Вычисление точки росы в градусах Цельсия (°C).:

Точка росы - рассчитываемый параметр, для этого воспользуемся формулой:

[latexmath]
++++
T_p = \frac{b \cdot y(T,Q)}{a - y(T,Q)}
++++

	- гдe T — температура в °C

	- Q - относительная влажность в объёмных долях

	- a = 17,27
    
	- b = 237,7 °C

Вычесление объёмной доли

[latexmath]
++++
y(T,Q) = \frac{a \cdot T}{b + T} + \ln Q
++++

формула перевода из относительной влажности (%) в объёмные доли:

[latexmath]
++++
Q = \frac{H_F}{100\%}
++++

*где:*
* `Hf` - относительная влажность в процентах (%)
* `Q` - влажность в объёмных долях (безразмерная величина, диапазон 0..1)


	- Период измерения физических вилечин составляет 100 мс.

	- В BME280 предусмотрен БИХ-фильтр, для более точных измерений он будет включен.

	- Общение с датчиком осуществляться по интерфейсу SPI2.

	- Объёмная доля - безразмерная величина, она выражается числом от 0 до 1, где 1 - является 100 %.

	- Выбор интерфейса осуществляется автоматически на основе статуса CSB (выбор чипа), если CSB отключен, активируется интерфейс SPI.


 
.Схема подключения 4-проводного SPI
image::schem_of_SPI.png[]

	- CSB – NSS (выбор кристалла).
	- SDI – MISO.
	- SDO – MOSI.

MISO и MOSI – это сигналы в интерфейсе SPI (Serial Peripheral Interface):  

	- MISO (Master In Slave Out) – вход ведущего, выход ведомого. Служит для передачи данных от ведомого устройства ведущему.

	- MOSI (Master Out Slave In) – выход ведущего, вход ведомого. Служит для передачи данных от ведущего устройства ведомому.

	- SCK  – последовательный тактовый сигнал (Serial Clock). Используется в синхронных протоколах связи для координации передачи данных между устройствами. 

	- Network Security Services (NSS) — набор библиотек, предназначенных для разработки защищённых кросс-платформенных приложений. Нам он необходим для выбора ведомого устройства.

Таким образом, получаем следующее
 

	. Bluetooth Bee HC-06

.Ключевые регистры USART2
[%autowidth]
|===
| Регистр | Описание                  | Смещение | Основные биты

| CR1
| Control Register 1
| 0x00
| UE, TE, RE, M, PCE, PS

| CR2
| Control Register 2
| 0x04
| STOP, LINEN, CLKEN

| CR3
| Control Register 3
| 0x08
| DMAT, DMAR, CTSE, RTSE

| BRR
| Baud Rate Register
| 0x0C
| DIV_Mantissa, DIV_Fraction

| SR
| Status Register
| 0x00
| TXE, RXNE, TC, ORE

| DR
| Data Register
| 0x04
| TX/RX данные (8/9 бит)
|===


Подключен к USART2 микроконтроллера через пины (источник https://www.st.com/resource/en/datasheet/stm32f411re.pdf стр. 48):

	- PА2 (TX) — передача данных.
	- PА3 (RX) — прием данных.
	- Период передачи данных: 1 секунда.

	. Датчик BME280

Подключен через интерфейс SPI4 микроконтроллера:

	- PB12 (NSS) — выбор ведомого устройства.

	- PB13 (SCK) — тактовый сигнал.

	- PB14 (MISO) — данные от датчика к микроконтроллеру.

	- PB15 (MOSI) — данные от микроконтроллера к датчику.

Период измерения параметров: 100 мс.

	. Микроконтроллер STM32

Координирует работу всех компонентов:

	- Чтение данных с BME280 через SPI4.

	- Передача данных через USART2 на HC-06.
    
Схема отражает аппаратную реализацию проекта, включая распиновку и временные параметры, заданные в техническом задании.

=== Описание всех задействованных регистров

.Регистры таймера TIM2

[%autowidth]
|===
| Регистр | Описание | Биты
| TIM2_CR1 | Control Register 1 | CEN, ARPE
| TIM2_PSC | Prescaler | 16-bit value
| TIM2_ARR | Auto-Reload Register | 16-bit value
| TIM2_DIER | Interrupt Enable Register | UIE
| TIM2_SR | Status Register | UIF
|===

.Регистры USART2

[%autowidth]
|===
| Регистр | Описание | Биты
| USART2_CR1 | Control Register 1 | UE, TE, RE, M
| USART2_CR2 | Control Register 2 | STOP
| USART2_BRR | Baud Rate Register | DIV_Mantissa, DIV_Fraction
| USART2_SR | Status Register | TXE, RXNE
| USART2_DR | Data Register | 8/9-bit data
|===

.Регистры SPI4 (для BME280)

[%autowidth]
|===
| Регистр | Описание | Биты
| SPI4_CR1 | Control Register 1 | SPE, MSTR, BR, CPOL, CPHA
| SPI4_DR | Data Register | 8/16-bit data
| SPI4_SR | Status Register | TXE, BSY
|===