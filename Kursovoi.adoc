= Отчет по курсовой работе
Шумаков А.С. <КЭ-413>
Газенкампф Д.В. <КЭ-413>
:imagesdir: image
:toc:
:toc-title: Оглавление
:figure-caption: Рисунок
:table-caption: Таблица
:sectnums: |,all|
:stem: latexmath
:numbered:

== Нефункциональные требования

[start = 1]
. Архитектурные требования
- Использование FreeRTOS и C++ обертки
- Предоставление UML-диаграмм:
  * Классов
  * Последовательностей
  * Компонентов
  * (Реализация в PlantUML)

. Требования к коду
- Читаемость и поддерживаемость:
  * Понятная структура кода
  * Наличие комментариев
  * Модульная организация

. Требования к надежности
- Корректная работа в автономном режиме:
  * Поддержка солнечного питания
  * Устойчивость к перепадам напряжения

. Ограничения реализации
- Запрет на использование эмуляторов:
  * Только работа на реальной плате
  * Требование физического прототипа

. Требования к интерфейсам
- Обязательные интерфейсы:
  * SPI для BME280
  * USART для HC-06

== Функциональные требования


[start = 1]
. Основная функциональность
   Прибор с помощью датчик BME280 должен измерять:
    - Температуру
    - Влажность
    - Атмосферное давление
   Период измерений: 100 мс

. Обработка данных:
   Расчет точки росы на основе:
    - Текущих значений температуры
    - Текущих значений влажности

. Передача данных:
   Формат вывода через Bluetooth:
    - "Давление: XXX.XX гПа"
    - "Влажность: XXX.XX %"
    - "Температура: XXX.XX C"
    - "Точка росы: XXX.XX C"
   Период передачи: 1 секунда

. Ограничения функциональности
 Аппаратные ограничения:
  - Использование только SPIx  для BME280
  - Использование USART2 для HC-06
  - Запрет на изменение формата вывода данных
  - Запрет на усреднение/фильтрацию данных для расчета точки росы


== Анализ требований 

.Взаимодействие элементов системы
image::schem_of_system.png[]

На изображении представлена схема подключения компонентов метеостанции к микроконтроллеру STM32:

=== Отладочная плата 

Отладочная плата XNUCLEO-F411RE на базе микроконтроллера STM32F411RE представляет собой ключевой компонент разрабатываемой системы. Данная плата оснащена 32-битным процессорным ядром Cortex-M4 с тактовой частотой 100 МГц, что обеспечивает достаточную производительность для реализации многозадачного программного обеспечения на операционной системе реального времени FreeRTOS. 

.Отладочная плата XNUCLEO-F411RE
image::plata.jpg[]

Объем встроенной памяти составляет 512 КБ Flash и 128 КБ RAM, что позволяет разместить комплексное приложение с поддержкой C++ и необходимыми библиотеками для работы с периферийными устройствами.

Для организации связи с датчиком BME280 используется интерфейс SPI. Согласно техническому заданию, должен быть задействован один из альтернативных SPI-портов. 

Плата предоставляет доступ к SPI2 (пины PE2, PE5, PE6, PE13) и SPI5, что соответствует требованиям проекта. Настройка интерфейса осуществляется в режиме Full-Duplex Master с частотой обмена данными, соответствующей характеристикам датчика.

=== Настройка SPI2 STM32F411RE

.Регистры RCC
[%autowidth]
|===
| Регистр | Назначение | Ключевые биты | Тип данных | Источник(https://goo.su/hUoKshN)


| *RCC_AHB1ENR* 
| Тактирование AHB1 периферии 
| GPIOA(1), GPIOB(1) 

| `uint32_t`
| RM0090 (стр. 182)

| *RCC_APB1ENR* 
| Тактирование APB1 периферии 
| `USART2EN`(17), `SPI2EN`(14)
| `uint32_t`
| RM0090 (стр. 185)

|===


Используется аппаратный SPI. Он на частотах до 25 MHz (для BME280 достаточно 10 MHz).У  аппаратного SPI нет задержек из-за прерываний.



Датчик BME280 поддерживает интерфейсы I²C и SPI, что делает его гибким для интеграции в различные системы. В данном проекте используется SPI из-за его высокой скорости и надёжности в условиях помех.

Особенности работы с BME280 по SPI

- Режим SPI:

CPOL = 0, CPHA = 0 (Mode 0) — стандартный режим для BME280.

- Скорость обмена:

Максимальная частота SCK для BME280 — 10 МГц

- Чтение/запись:

Первый бит адреса регистра указывает на операцию:

0x80 | reg — запись.

reg & 0x7F — чтение.




.Конфигурация линий SPI2
[%autowidth"]
|===
| Пин | Линия | Регистр MODER | Регистр AFR | Альтернативная функция

| PB12 | NSS 
| `MODER12[1:0] = 10` (Альтернативный)
| `AFRH12[3:0] = 0101` 
| AF5 (SPI2_NSS)

| PB13 | SCK 
| `MODER13[1:0] = 10` (Альтернативный)
| `AFRH13[3:0] = 0101` 
| AF5 (SPI2_SCK)

| PB14 | MISO 
| `MODER14[1:0] = 10` (Альтернативный)
| `AFRH14[3:0] = 0101` 
| AF5 (SPI2_MISO)

| PB15 | MOSI 
| `MODER15[1:0] = 10` (Альтернативный)
| `AFRH15[3:0] = 0101` 
| AF5 (SPI2_MOSI)
|===



.Регистры необходимые для настройки SPI2
[%autowidth]

|===
|Поля регистра SPI_CR1	|Описание | Тип данных |Состояния

|SPE	
|включение SPI	
| `bool`
|1 - Периферийное устройство включено.

|MSTR	
|Выбор мастера
| `bool`	
|1 - Master конфигурация.

|DFF	
|формат кадра данных
| `bool`	
|0 -для передачи/приема выбран 8-битный формат кадра данных.

|BR	
|Контроль скорости передачи данных
| `uint3_t`	
|000 - fPCLK/2

|CPOL,CPHA	
|программнно выбираются четыре варианта отношений таймингов интерфейса SPI
| `bool`	
|0 (CPOL,CPHA устанавливаются в 0, так как интерфейс SPI датчик BME280 совместим с режимом CPOL = CPHA = 0.)(https://roboparts.ru/upload/iblock/3ba/3ba8b9a547c432e79276186dd829340c.pdf?ysclid=m9n0hdi53p805898292 стр. 32)
|===

[%autowidth]

|===
|Поля регистра SPI_DR | Тип данных	|Описание

|DR	
| `uint16_t
|Регистр данных разделен на 2 буфера: один для записи (Transmit Buffer), другой для записи. чтение (Receive buffer)
|===

[%autowidth]

|===

|Поля регистра SPI_SR	|Описание | Тип данных	|Состояния

|BSY	
|флаг занятости.
| `bool`	
|0 - SPI не занят. 1 - SPI занят связью или буфер 

|Tx не пуст.
|TXE	буфер передачи пуст.	
| `bool`
|0 - буфер передачи не пуст. 1 - буфер передачи пуст
|===



Для настройки скорости SPI требуется придерживаться временной диаграммы интерфейса SPI датчика BME280


.Временная диаграмма SPI
image::time_diagram.png[]

.Тайминги SPI
[%autowidth]
|===
| Параметр | Краткое обозначение | Min | Max | Единица измерения

|Входная тактовая частота SPI|F_spi|0|10| МГц

|Низкий импульс SCK|T_low_sck |20 || нс

|Высокий импульс SCK|T_high_sck|20||нс

|Время установки SDI|T_setup_sdi|20||нс

|Время удержания SDI|T_hold_sdi|20||нс

|Задержка выхода SDO|T_delay_sdo, VDDIO = 1.6 V min||30|нс

|Задержка выхода SDO|T_delay_sdo, VDDIO = 1.2 V min||40|нс

|Время установки CSB|T_setup_csb|20||нс

|Время удержания CSB|T_hold_csb |20||нс
|===

.Регистры SPI2 (для BME280)

[%autowidth]
|===
| Регистр       | Описание                     | Биты / Поля                     | Значение (пример)

| *SPI2_CR1*    | Control Register 1           | `SPE` (SPI Enable)              | `1` (Включить SPI)
|               |                              | `MSTR` (Master/Slave)           | `1` (Режим Master) / `0` (Slave)
|               |                              | `BR[2:0]` (Baud Rate Control)   | `011` (f_PCLK / 8) / см. таблицу ниже
|               |                              | `CPOL` (Clock Polarity)         | `0` (SCK=0 в idle) / `1` (SCK=1 в idle)
|               |                              | `CPHA` (Clock Phase)            | `0` (сэмплинг по первому фронту) / `1` (по второму)

| *SPI2_DR*     | Data Register                | `DR[15:0]` (Data)               | Записываются данные для передачи (8/16 бит)

| *SPI2_SR*     | Status Register              | `TXE` (Transmit Empty)          | `1` (Буфер передачи пуст)
|               |                              | `BSY` (Busy Flag)               | `1` (SPI занят) / `0` (готов)
|===

Рассчитаем полный временной тайминг:

[latexmath]
++++
T_{All} = T_{low\_sck} + T_{high\_sck} + T_{setup\_sdi} + T_{hold\_sdi} + T_{delay\_sdo} + T_{setup\_csb} + T_{hold\_csb} = 150\,\text{нс}
++++

Переведем из временного интервала в частоту, используя условия 1 Гц = 1 цикл/с, следовательно

[latexmath]
++++
Frequency = \frac{1}{T_{All}}
++++

[latexmath]
++++
Frequence=6,67 МГц
++++

Датчик BME280 физически не может обрабатывать данные быстрее, чем 6.67 МГц. Если превысить эту частоту — данные будут теряться. Для стабильной работы возьмем частоту с запасом 4 МГц. Чтобы получить 4 МГц установим тактовую частоту генератора STM32 на 16 МГц и в регистре SPI установить значение 1 в бит BR (делитель частоты = 4), что даст частоту в 4,0 МГц на интерфейсе SPI2.


 
.Распиновка платы XNUCLEO-F411RE
image::pin_of_lab2.jpg[]

Передача метеоданных по беспроводному каналу реализована через модуль HC-06, подключенный к интерфейсу USART2. 

Используются стандартные пины PA2 (TX) и PA3 (RX), которые выводятся на контакты платы расширения Accessories Shield или I/O Expansion Shield. Скорость обмена установлена на 9600 бод, что является штатным режимом работы данного Bluetooth-модуля.

.Настройка USART
[%autowidth]
|===
| Этап настройки | Регистр/Параметр | Значение/Действие | Описание

| Тактирование
| RCC->APB1ENR
| USART2EN=1 (бит 17)
| Включение тактирования USART2

| 
| RCC->AHB1ENR
| GPIOAEN=1 (бит 0)
| Включение тактирования порта GPIOA

| Конфигурация GPIO
| GPIOA->MODER
| MODER2[1:0]=10 (PA2-TX)<br>MODER3[1:0]=10 (PA3-RX)
| Альтернативный режим для пинов

| 
| GPIOA->AFR[0]
| AFRL2[3:0]=AF7 AFRL3[3:0]=AF7
| Выбор AF7 (USART2)

| Настройка USART2
| USART2->BRR
| f_APB1/BaudRate (пример: 50MHz/9600=0x1458)
| Установка скорости передачи

| 
| USART2->CR1
| UE=1 (бит 13) TE=1 (бит 3)
| Включение USART, передатчика и приемника

| 
| USART2->CR2
| STOP[1:0]=00 (1 стоп-бит)
| Формат кадра

| 
| USART2->CR1
| M=0 (8 бит данных)
| Размер данных
|===



.последовательность настройки USART:
[%autowidth]
|===
| Этап | Регистры/Параметры | Действия

| 1. Включение тактирования
| RCC->APB1ENR (USARTxEN); RCC->AHB1ENR (GPIOxEN)
| Включить тактирование USART; Включить тактирование порта GPIO

| 2. Настройка GPIO
| GPIOx->MODER; GPIOx->AFRx; GPIOx->OSPEEDR
| Установить Alternate mode для TX/RX; Выбрать AF7 (USART); Настроить скорость (High)

| 3. Конфигурация USART
| USARTx->BRR
| - Рассчитать значение BaudRate:  `BRR = f_CLK / BaudRate`

| 4. Настройка формата
| USARTx->CR1; USARTx->CR2;
| 8 бит данных (M=0); 1 стоп-бит (STOP=00); Без контроля четности (PCE=0)

| 5. Активация
| USARTx->CR1 (UE, TE, RE)
| Включить USART (UE=1); Включить передатчик (TE=1)
|===

.Регистры USART2

[%autowidth]
|===
| Регистр       | Описание                     | Биты / Поля                     | Значение (пример)

| *USART2_CR1*  | Control Register 1           | `UE` (USART Enable)             | `1` (Включить USART)
|               |                              | `TE` (Transmitter Enable)       | `1` (Включить передатчик)
|               |                              | `M` (Word Length)               | `0` (8 бит данных) / `1` (9 бит)

| *USART2_CR2*  | Control Register 2           | `STOP[1:0]` (Stop Bits)         | `00` (1 стоп-бит) / `01` (0.5) / `10` (2) / `11` (1.5)
|               |                              | `CLKEN` (Clock Enable)          | `0` (Выключить тактирование)

| *USART2_BRR*  | Baud Rate Register           | `DIV_Mantissa[15:4]` (целая часть) | Рассчитывается по формуле: 
|               |                              | `DIV_Fraction[3:0]` (дробная часть) | `BRR = (F_ck / BaudRate)`, где `F_ck` — частота USART

| *USART2_SR*   | Status Register (Read-only)  | `TXE` (Transmit Empty)          | `1` (Буфер передачи пуст)
|               |                              | `RXNE` (Receive Not Empty)      | `1` (Данные приняты)

| *USART2_DR*   | Data Register                | `DR[8:0]` (Data)                | Записываются данные для передачи / читаются принятые
|===

.Подключение линий данных USART2
[%autowidth]
|===
| Наименование линий на STM| Пин на плате STM| Наименование линий на BlueTooth Bee HC-06  

| RX_STM | PA3 | TX_HC06 

| TX_STM | PA2 | RX_HC06
|===

Плата поддерживает подачу напряжения через разъем Vin (7-12 В) или E5V (5 В), что позволяет использовать солнечную батарею в качестве первичного источника энергии. Для стабилизации напряжения и защиты схемы рекомендуется включение в цепь дополнительного регулятора напряжения. 

=== Модуль HC-06

Модуль HC-06 – Bluetooth-передатчик для последовательной связи (UART) с ПК или смартфоном. Подключён к USART2 платы XNUCLEO-F411RE через плату расширения. Передаёт данные каждую секунду в формате:

"Давление: XXX.XX гПа

Влажность: XXX.XX %

Температура: XXX.XX C

Точка росы: XXX.XX C"
 
.Модуль HC-06
image::module_hc06.png[]

Работает на скорости 9600 бод, питается от 3.3–5 В, потребляет ~30 мА. Прост в настройке (базовые AT-команды), обеспечивает стабильную связь на расстоянии до 10 м.

=== Анализ и реализация периодичности измерений (100 мс)

Для обеспечения периодичности измерений в 100 мс будут использован RTOS 

FreeRTOS — это популярная операционная система реального времени (RTOS) с открытым исходным кодом, разработанная для встраиваемых систем. Она предоставляет механизмы для многозадачности, синхронизации, управления памятью и работы с периферией.


=== Анализ передачи данных через Bluetooth (HC-06)

Для передачи данных через Bluetooth модуль HC-06 используется USART2. Ниже приведена детальная настройка и алгоритм работы.

Настройка USART2:

- Скорость передачи: 9600 бод.
- Формат данных: 8 бит данных, 1 стоп-бит, без контроля четности.
- Пины: PA2 (TX), PA3 (RX).

Данные форматируются в строку и отправляются каждую секунду.

=== Датчик BME280

Датчик BME280 – цифровой сенсор для измерения температуры, влажности и атмосферного давления. В проекте подключён к микроконтроллеру через интерфейс SPI (используется порт SPIx, где x≠1,2,3). 

Обеспечивает высокую точность измерений: ±1°C для температуры, ±3% для влажности и ±1 гПа для давления.
 
.BME280
image::BME280.png[]


Датчик работает с частотой опроса 100 мс. Полученные данные используются для расчёта точки росы по формуле Магнуса. Питание осуществляется от 3.3 В, потребление в активном режиме – до 3.6 мкА при измерении всех параметров.

.Параметры датчика
[%autowidth]
|===
|Измеряемые физические величины | Система единиц |Регистры, где находятся необработанные выходные данные| объем данных, бит

| Давление | паскаль | 0xF7 - 0xF9  | 20 
| Температура | градусы цельсия | 0xFA - 0xFC  | 20 
| Влажность | % | 0xFD - 0xFE |  16 
|===

.Регистры настройки сбора данных
[%autowidth]
|===
|Регистр|Описание
|0xF4|Данные регистр используется для управления передискретизацией данных температуры и давления
|0xF2|Данные регистр используется для управления передискретизацией данных влажности
|===

Для регистра 0xF2 (ctrl_hum):

- Управляет только влажностью (биты 0-2)

- Перед изменением требует сначала записи в 0xF4

Для регистра 0xF4 (ctrl_meas):

- Комбинированный регистр (биты 7-5 - temp, 4-2 - press, 1-0 - режим)




Источник :
https://roboparts.ru/upload/iblock/3ba/3ba8b9a547c432e79276186dd829340c.pdf?ysclid=m9n0hdi53p805898292 (страницы : 25, 26 )



.Регистры необходимые для настройки датчика
[%autowidth]
|===
|Регистр | Описание | Тип данных| Страница в документации 

| 0x76| Адрес BME280 | uint8_t (константа)
 | 31

| 0xD0| ID регистр BME280 | uint8_t (read-only)
 | 25

| 0x60| Информация, читаемая от BME280 в ID регистре | uint8_t  |  24

| 0xE0| Регистр для перезагрузки BME280 | uint8_t (write-only)| 25

| 0xB6| Значение, записываемое в регистр для перезагрузки BME280 | uint8_t | 25

| 0xF3| Регистр статуса BME280 | uint8_t (read-only)
 | 25

| 0xF5| Регистр конфигурации BME280, задаём время ожидания, значение постоянной времени
фильтра BME280 | uint8_t (read/write)
 | 28
|===
Источник на регистры необходимые для настройки датчика:
https://roboparts.ru/upload/iblock/3ba/3ba8b9a547c432e79276186dd829340c.pdf?ysclid=m9n0hdi53p805898292

.Регистры калибровки
[%autowidth]
|===

|Адрес регистра|Обозначение регистра|Тип данных

|0x88 - 0x89|dig_T1|unsigned short

|0x8A - 0x8B|dig_T2|signed short

|0x8C - 0x8D|dig_T3|signed short
|===

Источник регистров калибровки :
https://roboparts.ru/upload/iblock/3ba/3ba8b9a547c432e79276186dd829340c.pdf?ysclid=m9n0hdi53p805898292 (страница 22)

	- dig_T - Обозначение регистра откуда читаем калибровочное значение температуры

	- Все данные передаются младшим байтом в перед, поэтому будет необходима функция перестановки байтов

Преобразование температуры в градусах Цельсия (°C):

[latexmath]

++++
X = \frac{adc_T}{16} - dig_{T1}
++++

	- adc_T – сырое значение АЦП (безразмерное, 20 бит)

- dig_T1, dig_T2, dig_T3 – калибровочные коэффициенты (int16, заводские единицы)

- X – промежуточное значение (безразмерное)


[latexmath]
++++
T_f = \frac{X \cdot dig_{T1} + \frac{X^2 \cdot dig_{T3}}{65536}}{1024}
++++

	- гдe T_f – итоговая температура (°C × 100, фиксированная точка)

Преобразование давления в паскалях :

[latexmath]

++++
D_F = \frac{adc_D}{16} \times 0.18
++++

где

- adc_D – сырое значение АЦП (безразмерное, 20 бит)

- D_F – итоговое давление (Па)

Преобразование Влажности в % относительной влажности (RH%):

[latexmath]
++++
H_F = adc_H \times 0.008
++++

где

- adc_H – сырое значение АЦП (безразмерное, 16 бит)

- H_F – итоговая влажность (% RH)

Вычисление точки росы в градусах Цельсия (°C).:

Точка росы - рассчитываемый параметр, для этого воспользуемся формулой:

[latexmath]
++++
T_p = \frac{b \cdot y(T,Q)}{a - y(T,Q)}
++++

где

- T – температура (°C)

- Q – относительная влажность (доли единицы, 0.0–1.0)

- a – константа (17.27, безразмерная)

- b – константа (237.7 °C)

- y(T, Q) – промежуточное значение (безразмерное)

- Tp – точка росы (°C)

Вычесление объёмной доли

[latexmath]
++++
y(T,Q) = \frac{a \cdot T}{b + T} + \ln Q
++++

формула перевода из относительной влажности (%) в объёмные доли:

[latexmath]
++++
Q = \frac{H_F}{100\%}
++++

*где:*
* `Hf` - относительная влажность в процентах (%)
* `Q` - влажность в объёмных долях (безразмерная величина, диапазон 0..1)


	- Период измерения физических вилечин составляет 100 мс.

	- В BME280 предусмотрен БИХ-фильтр, для более точных измерений он будет включен.

	- Общение с датчиком осуществляться по интерфейсу SPI2.

	- Объёмная доля - безразмерная величина, она выражается числом от 0 до 1, где 1 - является 100 %.

	- Выбор интерфейса осуществляется автоматически на основе статуса CSB (выбор чипа), если CSB отключен, активируется интерфейс SPI.


 
.Схема подключения 4-проводного SPI
image::schem_of_SPI.png[]

	- CSB – NSS (выбор кристалла).
	- SDI – MISO.
	- SDO – MOSI.

MISO и MOSI – это сигналы в интерфейсе SPI (Serial Peripheral Interface):  

	- MISO (Master In Slave Out) – вход ведущего, выход ведомого. Служит для передачи данных от ведомого устройства ведущему.

	- MOSI (Master Out Slave In) – выход ведущего, вход ведомого. Служит для передачи данных от ведущего устройства ведомому.

	- SCK  – последовательный тактовый сигнал (Serial Clock). Используется в синхронных протоколах связи для координации передачи данных между устройствами. 

	- Network Security Services (NSS) — набор библиотек, предназначенных для разработки защищённых кросс-платформенных приложений. Нам он необходим для выбора ведомого устройства.

Таким образом, получаем следующее
 

	. Bluetooth Bee HC-06

.Ключевые регистры USART2
[%autowidth]
|===
| Регистр | Описание                  | Смещение | Основные биты

| CR1
| Control Register 1
| 0x00
| UE, TE, RE, M, PCE, PS

| CR2
| Control Register 2
| 0x04
| STOP, LINEN, CLKEN

| CR3
| Control Register 3
| 0x08
| DMAT, DMAR, CTSE, RTSE

| BRR
| Baud Rate Register
| 0x0C
| DIV_Mantissa, DIV_Fraction

| SR
| Status Register
| 0x00
| TXE, RXNE, TC, ORE

| DR
| Data Register
| 0x04
| TX/RX данные (8/9 бит)
|===


Подключен к USART2 микроконтроллера через пины (источник https://www.st.com/resource/en/datasheet/stm32f411re.pdf стр. 48):

	- PА2 (TX) — передача данных.
	- PА3 (RX) — прием данных.
	- Период передачи данных: 1 секунда.

	. Датчик BME280

Подключен через интерфейс SPI2 микроконтроллера:

	- PB12 (NSS) — выбор ведомого устройства.

	- PB13 (SCK) — тактовый сигнал.

	- PB14 (MISO) — данные от датчика к микроконтроллеру.

	- PB15 (MOSI) — данные от микроконтроллера к датчику.

Период измерения параметров: 100 мс.

	. Микроконтроллер STM32

Координирует работу всех компонентов:

	- Чтение данных с BME280 через SPI2.

	- Передача данных через USART2 на HC-06.
    
Схема отражает аппаратную реализацию проекта, включая распиновку и временные параметры, заданные в техническом задании.

== UML дииграммы

UMl диаграммы представлены по ссылке ниже

link:Diagrams.adoc[]

== Заключение

В процессе разработки была создана архитектура ПО, представленная в виде UML-диаграм.

На основе этих диаграмм реализован программный код, который выполняет замеры давления, влажности и температуры, а также вычисляет точку росы. Измерения проводятся с интервалом 100 мс, а данные передаются через USART2 с периодичностью 1 секунда.

.Рабочая система
image::WorkingSystem.jpg[]

.Получение данных с отладочной платы
image::WorkingProgramm.jpg[]
