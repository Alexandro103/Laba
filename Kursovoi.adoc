= Отчет по курсовой работе
Шумаков А.С. <КЭ-413>
:imagesdir: image
:toc:
:toc-title: Оглавление
:figure-caption: Рисунок
:table-caption: Таблица
:sectnums: |,all|
:stem: latexmath
:numbered:

== Нефункциональные требования

[start = 1 ]

	. Архитектура:

	- Программное обеспечение должно быть разработано с использованием FreeRTOS и C++ обертки

	- Архитектура программы должна быть представлена в виде UML-диаграмм (классов, последовательностей, компонентов) в PlantUML

	. Стиль и стандарты:

	- Комментарии и структура кода должны быть понятны и поддерживаемы

	. Модули и задачи:

	- ПО должно измерять температуру, влажность (период 100 мс)

	- Использование очередей или буферов FreeRTOS для обмена данными между задачами

== Функциональные требования


[start = 1 ]

	. Аппаратная часть:
    
	- Использовать отладочную плату XNUCLEO-F411RE (ограничение)

	- Питание должно осуществляться автономно от солнечной батареи

	- Для подключения модуля BlueTooth использовать Accessories Shield или I/O Expansion Shield (ограничение)

	. Датчики и интерфейсы:

	- Измерение давления, влажности и температуры должно выполняться с помощью датчика BME280

	- Общение с датчиком BME280 должно происходить по SPIx, где x ≠ 1, 2, 3


	- Передача данных по Bluetooth через модуль HC-06 по 
    интерфейсу USART2


	. Измерения:

	- Период измерения параметров: 100 мс


	- Программа должна рассчитывать точку росы на основе текущих значений температуры и влажности


	. Формат вывода данных (через Bluetooth):

- "Давление: " XXX.XX [единицы измерения]

- "Влажность: " XXX.XX [единицы измерения]

- "Температура: " XXX.XX [единицы измерения]

- "Точка росы: " XXX.XX C

	- Период передачи данных по Bluetooth: 1 секунда

== Ограничения


. Аппаратные ограничения:

	- Используемая плата: Только XNUCLEO-F411RE 

	- Датчик: Только BME280 
	Интерфейс связи с датчиком: Только SPIx (x ≠ 1, 2, 3)

    - Bluetooth-модуль: Только HC-06 

	- Плата расширения: Только Accessories Shield или I/O Expansion Shield 

	- Питание: Только от солнечных батарей (использование USB, внешнего БП запрещено).

	- Запрещено добавлять или убирать строки в выводе.

	- Расчет точки росы должен выполняться только на основе текущих данных (без усреднения или фильтрации).


[start = 3 ]

. Ограничения по демонстрации:

	- Запрещено использовать эмуляторы (только работа на реальной плате).

== Анализ требований 

=== Отладочная плата 

Отладочная плата XNUCLEO-F411RE на базе микроконтроллера STM32F411RE представляет собой ключевой компонент разрабатываемой системы. Данная плата оснащена 32-битным процессорным ядром Cortex-M4 с тактовой частотой 100 МГц, что обеспечивает достаточную производительность для реализации многозадачного программного обеспечения на операционной системе реального времени FreeRTOS. 

.Отладочная плата XNUCLEO-F411RE
image::plata.jpg[]

Объем встроенной памяти составляет 512 КБ Flash и 128 КБ RAM, что позволяет разместить комплексное приложение с поддержкой C++ и необходимыми библиотеками для работы с периферийными устройствами.

Для организации связи с датчиком BME280 используется интерфейс SPI. Согласно техническому заданию, должен быть задействован один из альтернативных SPI-портов (x ≠ 1,2,3). 

Плата предоставляет доступ к SPI4 (пины PE2, PE5, PE6, PE13) и SPI5, что соответствует требованиям проекта. Настройка интерфейса осуществляется в режиме Full-Duplex Master с частотой обмена данными, соответствующей характеристикам датчика.

=== Настройка SPI2 STM32F411RE

.Конфигурация линий SPI2
[horizontal]
[cols="a, a"]
|===
|Пин	|Наименование линии

|PB12	
|NSS

|PB13	
|SCK

|PB14	
|MISO

|PB15	
|MOSI
|===

.Регистры необходимые для настройки SPI2
[horizontal]
[cols="a, a, a"]
|===
|Поля регистра SPI_CR1	|Описание|Состояния

|SPE	
|включение SPI	
|1 - Периферийное устройство включено.

|MSTR	
|Выбор мастера	
|1 - Master конфигурация.

|DFF	
|формат кадра данных	
|0 -для передачи/приема выбран 8-битный формат кадра данных.

|BR	
|Контроль скорости передачи данных	
|000 - fPCLK/2

|CPOL,CPHA	
|программнно выбираются четыре варианта отношений таймингов интерфейса SPI	
|0
|===

[horizontal]
[cols="a, a"]
|===
|Поля регистра SPI_DR	|Описание

|DR	
|Регистр данных разделен на 2 буфера: один для записи (Transmit Buffer), другой для записи. чтение (Receive buffer)
|===

[horizontal]
[cols="a, a, a"]
|===

|Поля регистра SPI_SR	|Описание	|Состояния

|BSY	
|флаг занятости.	
|0 - SPI не занят. 1 - SPI занят связью или буфер 

|Tx не пуст.
|TXE	буфер передачи пуст.	
|0 - буфер передачи не пуст. 1 - буфер передачи пуст
|===

CPOL,CPHA устанавливаются в 0, так как интерфейс SPI датчик BME280 совместим с режимом CPOL = CPHA = 0.

Для настройки скорости SPI требуется придерживаться временной диаграммы интерфейса SPI датчика BME280


.Временная диаграмма SPI
image::time_diagram.png[]

.Тайминги SPI
[%autowidth]
|===
| Параметр | Краткое обозначение | Min | Max | Единица измерения

|Входная тактовая частота SPI|F_spi|0|10| МГц

|Низкий импульс SCK|T_low_sck |20 || нс

|Высокий импульс SCK|T_high_sck|20||нс

|Время установки SDI|T_setup_sdi|20||нс

|Время удержания SDI|T_hold_sdi|20||нс

|Задержка выхода SDO|T_delay_sdo, VDDIO = 1.6 V min||30|нс

|Задержка выхода SDO|T_delay_sdo, VDDIO = 1.2 V min||40|нс

|Время установки CSB|T_setup_csb|20||нс

|Время удержания CSB|T_hold_csb |20||нс
|===

Рассчитаем полный временной тайминг:

[latexmath]
++++
T_{All} = T_{low\_sck} + T_{high\_sck} + T_{setup\_sdi} + T_{hold\_sdi} + T_{delay\_sdo} + T_{setup\_csb} + T_{hold\_csb} = 150\,\text{нс}
++++

Переведем из временного интервала в частоту, используя условия 1 Гц = 1 цикл/с, следовательно

[stem]
++++
Frequency = \frac{1}{T_{All}}
++++

[stem]
++++
Frequence=6,67 МГц
++++

Нельзя устанавливать частоту работы SPI > Frequency, следовательно установим тактовую частоту генератора STM32 на 16 МГц и в регистре SPI установить значение 1 в бит BR, что даст частоту в 4,0 МГц на интерфейсе SPI2.

 
.Распиновка платы XNUCLEO-F411RE
image::pin_of_lab.jpg[]

Передача метеоданных по беспроводному каналу реализована через модуль HC-06, подключенный к интерфейсу USART2. 

Используются стандартные пины PA2 (TX) и PA3 (RX), которые выводятся на контакты платы расширения Accessories Shield или I/O Expansion Shield. Скорость обмена установлена на 9600 бод, что является штатным режимом работы данного Bluetooth-модуля.

.Подключение линий данных USART2
[%autowidth]
|===
| Наименование линий на STM| Пин на плате STM| Наименование линий на BlueTooth Bee HC-06  

| RX_STM | PD5 | TX_HC06 

| TX_STM | PD6 | RX_HC06
|===

Плата поддерживает подачу напряжения через разъем Vin (7-12 В) или E5V (5 В), что позволяет использовать солнечную батарею в качестве первичного источника энергии. Для стабилизации напряжения и защиты схемы рекомендуется включение в цепь дополнительного регулятора напряжения. 

=== Модуль HC-06

Модуль HC-06 – Bluetooth-передатчик для последовательной связи (UART) с ПК или смартфоном. Подключён к USART2 платы XNUCLEO-F411RE через плату расширения. Передаёт данные каждую секунду в формате:

"Давление: XXX.XX гПа

Влажность: XXX.XX %

Температура: XXX.XX C

Точка росы: XXX.XX C"
 
.Модуль HC-06
image::module_hc06.png[]

Работает на скорости 9600 бод, питается от 3.3–5 В, потребляет ~30 мА. Прост в настройке (базовые AT-команды), обеспечивает стабильную связь на расстоянии до 10 м.

=== Датчик BME280

Датчик BME280 – цифровой сенсор для измерения температуры, влажности и атмосферного давления. В проекте подключён к микроконтроллеру через интерфейс SPI (используется порт SPIx, где x≠1,2,3). 

Обеспечивает высокую точность измерений: ±1°C для температуры, ±3% для влажности и ±1 гПа для давления.
 
.BME280
image::BME280.png[]


Датчик работает с частотой опроса 100 мс. Полученные данные используются для расчёта точки росы по формуле Магнуса. Питание осуществляется от 3.3 В, потребление в активном режиме – до 3.6 мкА при измерении всех параметров.

.Параметры датчика
[%autowidth]
|===
|Измеряемые физические величины | Система единиц |Регистры, где находятся необработанные выходные данные| объем данных, бит

| Давление | паскаль | 0xF7 - 0xF9  | 20 
| Температура | градусы цельсия | 0xFA - 0xFC  | 20 
| Влажность | % | 0xFD - 0xFE |  16 
|===

.Регистры настройки сбора данных
[%autowidth]
|===
|Регистр|Описание
|0xF4|Данные регистр используется для управления передискретизацией данных температуры и давления
|0xF2|Данные регистр используется для управления передискретизацией данных влажности
|===

.Регистры необходимые для настройки датчика
[%autowidth]
|===
|Регистр | Описание | Страница в документации 

| 0x76| Адрес BME280 | 32

| 0xD0| ID регистр BME280 | 26

| 0x60| Информация, читаемая от BME280 в ID регистре | 26

| 0xE0| Регистр для перезагрузки BME280 | 26

| 0xB6| Значение, записываемое в регистр для перезагрузки BME280 | 26

| 0xF3| Регистр статуса BME280 | 26

| 0xF5| Регистр конфигурации BME280, задаём время ожидания, значение постоянной времени
фильтра BME280 | 28
|===

.Регистры калибровки
[%autowidth]
|===

|Адрес регистра|Обозначение регистра|Тип данных

|0x88 - 0x89|dig_T1|unsigned short

|0x8A - 0x8B|dig_T2|signed short

|0x8C - 0x8D|dig_T3|signed short
|===

	- dig_T - Обозначение регистра откуда читаем калибровочное значение температуры

	- Все данные передаются младшим байтом в перед, поэтому будет необходима функция перестановки байтов

Преобразование температуры:

[stem]
++++
X = \frac{adc_T}{16} - dig_{T1}
++++

	- гдe adc_T — значение температуры полученное из регистра

[stem]
++++
T_f = \frac{X \cdot dig_{T1} + \frac{X^2 \cdot dig_{T3}}{65536}}{1024}
++++

	- гдe Tf — конечное значение температуры

Преобразование давления:

[stem]
++++
D_F = \frac{adc_D}{16} \times 0.18
++++

	- гдe adc_D — значение давления полученное из регистра

	- D_F — конечное значение давления

Преобразование Влажности:

[stem]
++++
H_F = adc_H \times 0.008
++++

	- гдe adc_H — значение влажности полученное из регистра

	- Hf — конечное значение влажности

Вычисление точки росы:

Точка росы - рассчитываемый параметр, для этого воспользуемся формулой:

[stem]
++++
T_p = \frac{b \cdot y(T,Q)}{a - y(T,Q)}
++++

	- гдe T — температура в °C

	- Q - относительная влажность в объёмных долях

	- a = 17,27
    
	- b = 237,7 °C

[stem]
++++
y(T,Q) = \frac{a \cdot T}{b + T} + \ln Q
++++

	- Период измерения физических вилечин составляет 100 мс.

	- В BME280 предусмотрен БИХ-фильтр, для более точных измерений он будет включен.

	- Общение с датчиком осуществляться по интерфейсу SPI2.

	- Объёмная доля - безразмерная величина, она выражается числом от 0 до 1, где 1 - является 100 %.

	- Выбор интерфейса осуществляется автоматически на основе статуса CSB (выбор чипа), если CSB отключен, активируется интерфейс SPI.


 
.Схема подключения 4-проводного SPI
image::schem_of_SPI.png[]

	- CSB – NSS (выбор кристалла).
	- SDI – MISO.
	- SDO – MOSI.

MISO и MOSI – это сигналы в интерфейсе SPI (Serial Peripheral Interface):  

	- MISO (Master In Slave Out) – вход ведущего, выход ведомого. Служит для передачи данных от ведомого устройства ведущему.

	- MOSI (Master Out Slave In) – выход ведущего, вход ведомого. Служит для передачи данных от ведущего устройства ведомому.

	- SCK  – последовательный тактовый сигнал (Serial Clock). Используется в синхронных протоколах связи для координации передачи данных между устройствами. 

	- Network Security Services (NSS) — набор библиотек, предназначенных для разработки защищённых кросс-платформенных приложений. Нам он необходим для выбора ведомого устройства.

Таким образом, получаем следующее
 
.Взаимодействие элементов системы
image::schem_of_system.png[]

На изображении представлена схема подключения компонентов метеостанции к микроконтроллеру STM32:

	. Bluetooth Bee HC-06

Подключен к USART2 микроконтроллера через пины:

	- PD5 (TX) — передача данных.
	- PD6 (RX) — прием данных.
	- Период передачи данных: 1 секунда.

	. Датчик BME280

Подключен через интерфейс SPI4 микроконтроллера:

	- PA1 (NSS) — выбор ведомого устройства.

	- PE12 (SCK) — тактовый сигнал.

	- PE13 (MISO) — данные от датчика к микроконтроллеру.

	- PE14 (MOSI) — данные от микроконтроллера к датчику.

Период измерения параметров: 100 мс.

	. Микроконтроллер STM32

Координирует работу всех компонентов:

	- Чтение данных с BME280 через SPI4.

	- Передача данных через USART2 на HC-06.
    
Схема отражает аппаратную реализацию проекта, включая распиновку и временные параметры, заданные в техническом задании.

